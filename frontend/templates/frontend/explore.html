<!DOCTYPE html>
<html>
<head>
    <title>Explore Game Lores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: white; font-family: Arial, Helvetica, sans-serif; }
        .container { max-width: 1200px; }

        h2 { font-weight: 600; margin-top: 40px; margin-bottom: 20px; }
        .explore-link { text-decoration: none; color: #000; font-weight: 800; }
        .explore-link:hover { color: #0d6efd; }

        .btn-primary { border-radius: 20px; padding: 10px 20px; font-weight: 500; }

        .game-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s ease;
            width: 100%;
            max-width: 320px;
        }
        .game-card:hover { transform: translateY(-5px); }

        .img-container {
            width: 100%;
            height: 260px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .img-container img { width: 100%; height: 100%; object-fit: cover; }

        .game-title { text-align: center; font-weight: 600; font-size: 1.15rem; margin-top: 10px; margin-bottom: 15px; }
        .game-title a { text-decoration: none; color: #000; transition: color 0.2s ease; }
        .game-title a:hover { color: #007bff; }

        .row { justify-content: center; }
        .col-md-4 { display: flex; justify-content: center; }

        /* Score + Rating obok siebie */
        .rating-section { text-align: center; }
        .rating-row { display: flex; justify-content: center; align-items: center; gap: 25px; flex-wrap: wrap; }
        .score-item, .rating-item { display: flex; align-items: center; gap: 6px; font-weight: 500; font-size: 1rem; }

        .score-box {
            display: inline-block; padding: 3px 8px; border-radius: 5px;
            font-weight: 700; color: #000; border: 1.5px solid #000;
            min-width: 30px; text-align: center;
        }
        .gold { background-color: #f6c700; }
        .green { background-color: #00e676; }
        .yellow { background-color: #ffee58; }
        .purple { background-color: #b39ddb; }
        .red { background-color: #ef5350; color: #fff; }
        .blue { background-color: #42a5f5; color: #fff; }

        .star { color: #f6c700; font-size: 1.1rem; margin-left: 3px; }
        .label { color: #333; font-weight: 600; }

        /* Sort select */
        select.form-select {
            border-radius: 20px;
            padding: 6px 16px;
            font-weight: 500;
            cursor: pointer;
            min-width: 230px;
            max-width: 300px;
        }

        /* Search bar z Genres po prawej */
        .search-wrap { display: flex; justify-content: center; }
        .search-input {
          height: 40px;
          padding: 10px 16px;
          border-top-left-radius: 999px !important;
          border-bottom-left-radius: 999px !important;
          border-right: 1px solid #ced4da !important; /* <- dopasowany kolor */
        }

        #genreToggle {
            border-radius: 0 !important; /* środkowy przycisk bez zaokrąglenia */
            border-left: 1px solid var(--bs-border-color) !important; /* separator tej samej grubości/koloru */
        }
        .input-group .btn-outline-primary {
            border-top-right-radius: 999px !important;
            border-bottom-right-radius: 999px !important;
            border-left: 0 !important; /* brak podwójnej kreski między Genres a Search */
        }

        /* Panel gatunków i pigułki */
        .genre-panel {
            border: 1px solid #cfcfcf;
            border-radius: 12px;
            padding: 16px 14px;
            background: #fff;
        }
        .btn-genre {
            border-radius: 12px;
            border: 1px solid #bbb;
            background: #f7f7f7;
            font-weight: 500;
            padding: 6px 10px;
        }
        .btn-genre.active {
            background: #00e676;
            color: #000;
            border-color: #000;
        }
        .explore-heading {
          font-weight: 600;
          margin-top: 40px;
          margin-bottom: 20px;
          font-size: 2rem;
        }

        .explore-link {
          text-decoration: none;
          color: #000;
          font-family: inherit; /* <<< zachowuje czcionkę z h2 */
          font-weight: inherit;
        }

        .explore-link:hover {
          color: #0d6efd;
        }

    </style>
</head>
<body>
<div class="container text-center">

    <!-- Nagłówek jako „reset” listy -->
    <h2 class="explore-heading">
  <a href="/app/explore/" class="explore-link">Explore Game Lores</a>
</h2>


    <!-- Search bar + genre toggle (przycisk z prawej strony) -->
    <form method="get" class="search-wrap mb-3" onsubmit="return true;">
      <div class="input-group mx-auto" style="max-width: 720px;">

        <!-- pole tekstowe -->
        <input type="text"
               name="q"
               class="form-control search-input"
               placeholder="Search for the games in the database"
               value="{{ query }}">

        <!-- ukryte wartości -->
        <input type="hidden" name="sort" value="{{ sort_option }}">
        <input type="hidden" name="genre" id="genreInput" value="{{ selected_genre }}">

        <!-- przycisk genres po prawej -->
        <button type="button" id="genreToggle" class="btn btn-outline-secondary">
          Genres <span id="genreCaret">▾</span>
        </button>

        <!-- przycisk search -->
        <button class="btn btn-outline-primary" type="submit">Search</button>
      </div>
    </form>

    <!-- Panel z gatunkami (toggle) -->
    <div id="genrePanel" class="genre-panel mx-auto mb-4" style="max-width: 720px; display: none;">
      <div class="text-center fw-semibold mb-2">Genres from the database</div>
      <div class="d-flex flex-wrap gap-2 justify-content-center">
        {% for g in genres %}
          <button type="button"
                  class="btn btn-sm btn-genre {% if selected_genre == g %}active{% endif %}"
                  data-genre="{{ g }}">{{ g }}</button>
        {% endfor %}
      </div>
    </div>

    <div class="mb-4">
        <a href="/app/search/" class="btn btn-primary">Search for a new game</a>
    </div>

    <!-- Sorter -->
    <div class="d-flex justify-content-center align-items-center mb-4 gap-3">
      <label for="sortSelect" class="fw-bold">Sort by:</label>
      <select id="sortSelect" class="form-select" style="width: 250px;" onchange="handleSortChange(this)">
        <option value="oldest" {% if sort_option == "oldest" %}selected{% endif %}>Date added (Oldest)</option>
        <option value="newest" {% if sort_option == "newest" %}selected{% endif %}>Date added (Newest)</option>
        <option value="score"  {% if sort_option == "score" %}selected{% endif %}>Score</option>
        <option value="rating" {% if sort_option == "rating" %}selected{% endif %}>Rating</option>
      </select>
    </div>

    {% if games %}
        <div class="row gy-5">
            {% for game in games %}
            <div class="col-md-4">
                <div class="game-card">
                    <div class="img-container">
                        {% if game.cover_image %}
                            <img src="/media/{{ game.cover_image }}" alt="{{ game.title }}">
                        {% else %}
                            <img src="/media/placeholder.jpg" alt="No image">
                        {% endif %}
                    </div>

                    <div class="game-title">
                        <a href="/app/games/{{ game.id }}/">{{ game.title }}</a>
                    </div>

                    <div class="rating-section mb-3">
                        <div class="rating-row">
                            <div class="score-item">
                                <span class="label">Score:</span>
                                {% if game.score %}
                                    <span class="score-box
                                        {% if game.score >= 9.0 %}gold
                                        {% elif game.score >= 8.0 %}green
                                        {% elif game.score >= 6.0 %}yellow
                                        {% elif game.score >= 4.0 %}purple
                                        {% elif game.score >= 0.0 %}red
                                        {% endif %}
                                    ">{{ game.score }}</span>
                                {% else %}
                                    <span class="score-box blue">?</span>
                                {% endif %}
                            </div>

                            <div class="rating-item">
                                <span class="label">Rating:</span>
                                {% if game.rating %}
                                    {{ game.rating }}/10 <span class="star">★</span>
                                {% else %}
                                    N/A <span class="star">★</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div><!-- /.game-card -->
            </div><!-- /.col -->
            {% endfor %}
        </div>
    {% else %}
        <p>No games in the database yet.</p>
    {% endif %}
</div>

<script>
  // toggle panelu gatunków
  const panel = document.getElementById('genrePanel');
  const toggle = document.getElementById('genreToggle');
  const caret  = document.getElementById('genreCaret');
  const genreInput = document.getElementById('genreInput');

  // Pokaż panel po odświeżeniu, jeśli był wybrany gatunek
  if (panel && caret && "{{ selected_genre }}") {
    panel.style.display = 'block';
    caret.textContent = '▴';
  }

  // Toggle panelu po kliknięciu "Genres"
  if (toggle && panel && caret) {
    toggle.addEventListener('click', () => {
      const visible = panel.style.display !== 'none';
      panel.style.display = visible ? 'none' : 'block';
      caret.textContent = visible ? '▾' : '▴';
    });
  }

  // Jednokrotny wybór gatunku (kliknięcie drugi raz = wyczyść)
  document.querySelectorAll('.btn-genre').forEach(btn => {
    btn.addEventListener('click', () => {
      const current = genreInput.value;
      const pick = btn.dataset.genre;

      if (current === pick) {
        // odkliknięcie
        genreInput.value = '';
        btn.classList.remove('active');
      } else {
        // wyczyść inne aktywne
        document.querySelectorAll('.btn-genre.active').forEach(b => b.classList.remove('active'));
        // ustaw nowy
        genreInput.value = pick;
        btn.classList.add('active');
      }
    });
  });

  // Zachowaj q i genre przy zmianie sortowania
  function handleSortChange(select) {
    const sort = select.value;
    const currentUrl = new URL(window.location.href);
    const q = currentUrl.searchParams.get('q') || '';
    const genre = document.getElementById('genreInput').value || currentUrl.searchParams.get('genre') || '';

    currentUrl.searchParams.set('sort', sort);
    if (q) currentUrl.searchParams.set('q', q); else currentUrl.searchParams.delete('q');
    if (genre) currentUrl.searchParams.set('genre', genre); else currentUrl.searchParams.delete('genre');

    window.location.href = currentUrl.toString();
  }
</script>
</body>
</html>
