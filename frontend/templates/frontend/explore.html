<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Explore Game Lores - GameLore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --nav:#0f1836;
      --gold:#d6b679;
      --shadow:0 12px 28px rgba(0,0,0,.25);
      --radius:18px;
    }
    body{
      background:#f4f6fa;
      font-family:"Segoe UI", Roboto, sans-serif;
      color:#222;
      margin:0;
    }

    /* NAVBAR */
    .navbar{
      background:var(--nav);
      padding:8px 20px;
      display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 3px 10px rgba(0,0,0,.18);
    }
    .brand img{height:72px}            /* większe logo w lewym górnym rogu */
    .profile-chip{
      display:inline-flex;
      align-items:center;
      gap:12px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.30);
      padding:8px 14px;
      border-radius:14px;
      color:#fff;
      text-decoration:none;
      white-space:nowrap;
    }
    .profile-chip span{font-weight:700;font-size:1.25rem;}
    .profile-chip img{
      width:56px;height:56px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid rgba(255,255,255,.6);
      background:#fff;
    }

    /* GŁÓWNA ZAWARTOŚĆ */
    .container{
      max-width:1200px;
      margin-top:50px;
      text-align:center;
    }

    .explore-heading{
      font-weight:700;
      color:var(--nav);
      margin-bottom:20px;
      font-size:2.2rem;
    }
    .explore-heading a{
      color:inherit;
      text-decoration:none;
      transition:color .2s;
    }
    .explore-heading a:hover{
      color:#1c2c6a;
    }

    /* SEARCH BAR + GENRES */
    .search-wrap{
      display:flex;
      justify-content:center;
      margin-bottom:20px;
    }
    .search-input{
      height:44px;
      padding:10px 16px;
      border-top-left-radius:999px!important;
      border-bottom-left-radius:999px!important;
      border-right:1px solid #ccc!important;
      font-size:1rem;
    }
    #genreToggle{
      border-radius:0!important;
      border-left:1px solid #ccc!important;
      font-weight:600;
    }
    .input-group .btn-outline-primary{
      border-top-right-radius:999px!important;
      border-bottom-right-radius:999px!important;
      border-left:0!important;
      font-weight:600;
      background:var(--nav);
      color:var(--gold);
      border-color:var(--nav);
    }
    .input-group .btn-outline-primary:hover{
      background:#182b5c;
      color:#f5dca1;
    }

    .genre-panel{
      border:1px solid #cfcfcf;
      border-radius:12px;
      padding:16px 14px;
      background:#fff;
      max-width:720px;
      margin:0 auto 20px;
      display:none;
      box-shadow:0 3px 10px rgba(0,0,0,.08);
    }
    .btn-genre{
      border-radius:12px;
      border:1px solid #bbb;
      background:#f7f7f7;
      font-weight:500;
      padding:6px 10px;
      transition:all .2s ease;
    }
    .btn-genre.active{
      background:#00e676;
      color:#000;
      border-color:#000;
    }

    /* PRZYCISK SEARCH NOWEJ GRY */
    .btn-primary{
      background:var(--nav);
      border:none;
      border-radius:20px;
      padding:10px 24px;
      font-weight:600;
      color:var(--gold);
      box-shadow:var(--shadow);
      transition:background .2s;
    }
    .btn-primary:hover{
      background:#182b5c;
      color:#f5dca1;
    }

    /* SORTER */
    label.fw-bold{color:#222;}
    select.form-select{
      border-radius:20px;
      padding:6px 16px;
      font-weight:500;
      cursor:pointer;
      min-width:230px;
    }

    /* KAFELKI GIER */
    .game-card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 3px 10px rgba(0,0,0,.1);
      overflow:hidden;
      transition:transform .2s ease, box-shadow .2s ease;
      width:100%;
      max-width:320px;
    }
    .game-card:hover{
      transform:translateY(-5px);
      box-shadow:0 8px 20px rgba(0,0,0,.2);
    }
    .img-container{
      width:100%;height:260px;
      display:flex;justify-content:center;align-items:center;
      overflow:hidden;
    }
    .img-container img{
      width:100%;height:100%;object-fit:cover;
    }
    .game-title{
      text-align:center;
      font-weight:600;
      font-size:1.15rem;
      margin-top:10px;margin-bottom:15px;
    }
    .game-title a{
      text-decoration:none;
      color:var(--nav);
      transition:color .2s;
    }
    .game-title a:hover{
      color:#1c2c6a;
    }

    /* SCORE + RATING */
    .rating-section{text-align:center;}
    .rating-row{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:25px;
      flex-wrap:wrap;
    }
    .score-item,.rating-item{
      display:flex;align-items:center;gap:6px;
      font-weight:500;font-size:1rem;
    }
    .score-box{
      display:inline-block;
      padding:3px 8px;
      border-radius:5px;
      font-weight:700;
      min-width:30px;
      text-align:center;
    }
    .gold { background-color: #d4af37;}
    .green{background-color:#00e676;}
    .yellow{background-color:#ffee58;}
    .purple{background-color:#b39ddb;}
    .red{background-color:#ef5350;color:#fff;}
    .blue{background-color:#42a5f5;color:#fff;}
    .star{color:#f6c700;font-size:1.1rem;margin-left:3px;}
    .label{color:#333;font-weight:600;}

    .no-games{
      text-align:center;
      color:#666;
      font-size:1.2rem;
      margin-top:80px;
    }

    @media(max-width:640px){
      .brand img{height:54px;}
      .profile-chip img{width:42px;height:42px;}
      .profile-chip span{font-size:1.05rem;}
    }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar">
    <div class="brand">
      <a href="/" style="text-decoration:none;">
        <img src="/media/icons/Logo.png" alt="Logo">
      </a>
    </div>

    <a href="/app/profile/" class="profile-chip">
      {% if user %}
        <span>{{ user.username }}</span>
        {% if user.profile_picture %}
          <img src="/media/{{ user.profile_picture }}" alt="{{ user.username }}">
        {% endif %}
      {% else %}
        <span>Profile</span>
      {% endif %}
    </a>
  </nav>

  <!-- GŁÓWNA TREŚĆ -->
  <div class="container text-center">
    <h2 class="explore-heading">
      <a href="/app/explore/" class="explore-link">Explore Game Lores</a>
    </h2>

    <!-- Search bar -->
    <form method="get" class="search-wrap mb-3" onsubmit="return true;">
      <div class="input-group mx-auto" style="max-width:720px;">
        <input type="text" name="q" class="form-control search-input"
               placeholder="Search for the games in the database"
               value="{{ query }}">
        <input type="hidden" name="sort" value="{{ sort_option }}">
        <input type="hidden" name="genre" id="genreInput" value="{{ selected_genre }}">
        <button type="button" id="genreToggle" class="btn btn-outline-secondary">Genres <span id="genreCaret">▾</span></button>
        <button class="btn btn-outline-primary" type="submit">Search</button>
      </div>
    </form>

    <!-- Panel gatunków -->
    <div id="genrePanel" class="genre-panel">
      <div class="fw-semibold mb-2">Genres from the database</div>
      <div class="d-flex flex-wrap gap-2 justify-content-center">
        {% for g in genres %}
          <button type="button" class="btn btn-sm btn-genre {% if selected_genre == g %}active{% endif %}" data-genre="{{ g }}">{{ g }}</button>
        {% endfor %}
      </div>
    </div>

    <div class="mb-4">
      <a href="/app/search/" class="btn btn-primary">Search for a new game</a>
    </div>

    <!-- Sort -->
    <div class="d-flex justify-content-center align-items-center mb-4 gap-3">
      <label for="sortSelect" class="fw-bold">Sort by:</label>
      <select id="sortSelect" class="form-select" style="width:250px;" onchange="handleSortChange(this)">
        <option value="oldest" {% if sort_option == 'oldest' %}selected{% endif %}>Date added (Oldest)</option>
        <option value="newest" {% if sort_option == 'newest' %}selected{% endif %}>Date added (Newest)</option>
        <option value="score"  {% if sort_option == 'score'  %}selected{% endif %}>Score</option>
        <option value="rating" {% if sort_option == 'rating' %}selected{% endif %}>Rating</option>
      </select>
    </div>

    {% if games %}
      <div class="row gy-5 justify-content-center">
        {% for game in games %}
        <div class="col-md-4 d-flex justify-content-center">
          <div class="game-card">
            <div class="img-container">
              {% if game.cover_image %}
                <img src="/media/{{ game.cover_image }}" alt="{{ game.title }}">
              {% else %}
                <img src="/media/placeholder.jpg" alt="No image">
              {% endif %}
            </div>

            <div class="game-title">
              <a href="/app/games/{{ game.id }}/">{{ game.title }}</a>
            </div>

            <div class="rating-section mb-3">
              <div class="rating-row">
                <div class="score-item">
                  <span class="label">Score:</span>
                  {% if game.score %}
                    <span class="score-box
                      {% if game.score >= 9.0 %}gold
                      {% elif game.score >= 8.0 %}green
                      {% elif game.score >= 6.0 %}yellow
                      {% elif game.score >= 4.0 %}purple
                      {% elif game.score >= 0.0 %}red
                      {% endif %}">{{ game.score }}</span>
                  {% else %}
                    <span class="score-box blue">?</span>
                  {% endif %}
                </div>
                <div class="rating-item">
                  <span class="label">Rating:</span>
                  {% if game.rating %}
                    {{ game.rating }}/10 <span class="star">★</span>
                  {% else %}
                    N/A <span class="star">★</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="no-games">No games in the database yet.</p>
    {% endif %}
  </div>

  <!-- Skrypt -->
  <script>
    const panel=document.getElementById('genrePanel');
    const toggle=document.getElementById('genreToggle');
    const caret=document.getElementById('genreCaret');
    const genreInput=document.getElementById('genreInput');

    if(panel&&caret&&"{{ selected_genre }}"){
      panel.style.display='block';
      caret.textContent='▴';
    }

    if(toggle&&panel&&caret){
      toggle.addEventListener('click',()=>{
        const visible=panel.style.display!=='none';
        panel.style.display=visible?'none':'block';
        caret.textContent=visible?'▾':'▴';
      });
    }

    document.querySelectorAll('.btn-genre').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const current=genreInput.value;
        const pick=btn.dataset.genre;
        if(current===pick){
          genreInput.value='';
          btn.classList.remove('active');
        }else{
          document.querySelectorAll('.btn-genre.active').forEach(b=>b.classList.remove('active'));
          genreInput.value=pick;
          btn.classList.add('active');
        }
      });
    });

    function handleSortChange(select){
      const sort=select.value;
      const currentUrl=new URL(window.location.href);
      const q=currentUrl.searchParams.get('q')||'';
      const genre=document.getElementById('genreInput').value||currentUrl.searchParams.get('genre')||'';
      currentUrl.searchParams.set('sort',sort);
      if(q)currentUrl.searchParams.set('q',q);else currentUrl.searchParams.delete('q');
      if(genre)currentUrl.searchParams.set('genre',genre);else currentUrl.searchParams.delete('genre');
      window.location.href=currentUrl.toString();
    }
  </script>
</body>
</html>
